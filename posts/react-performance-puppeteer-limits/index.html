<!DOCTYPE html><html lang="en" prefix="og: http://ogp.me/ns#"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta http-equiv="Content-Security-Policy" content="default-src 'none'; img-src 'self';  manifest-src 'self'; script-src 'none'; object-src 'none'; style-src 'self' 'unsafe-inline';"><title>Performance testing with slow network and CPU using Puppeteer and React</title><meta property="og:title" content="Performance testing with slow network and CPU using Puppeteer and React"><meta name="description" content="This article shows how to do performance testing for the slow network or CPU using Puppeteer and React"><meta property="og:description" content="This article shows how to do performance testing for the slow network or CPU using Puppeteer and React"><meta name="keywords" content="performance-testing, web-testing, puppeteer, react, slow-network"><link rel="canonical" href="https://drag13.io/posts/react-performance-puppeteer-limits/index.html"><meta property="og:url" content="https://drag13.io/posts/react-performance-puppeteer-limits/index.html"><meta property="og:type" content="website"><meta name="twitter:card" content="summary"><meta name="twitter:site" content="https://twitter.com/drag137"><meta name="twitter:url" content="https://drag13.io/posts/react-performance-puppeteer-limits/index.html"><meta name="twitter:title" content="Performance testing with slow network and CPU using Puppeteer and React"><meta name="twitter:description" content="This article shows how to do performance testing for the slow network or CPU using Puppeteer and React"><meta name="og:site_name" content="Drag13 Dev Blog"><meta property="og:image" content="https://drag13.io/react-performance-puppeteer-profile-kdpv.d850c2c2.jpg"><meta name="twitter:image" content="https://drag13.io/react-performance-puppeteer-profile-kdpv.d850c2c2.jpg"><meta name="application-name" content="Drag13 programmer's blog"><meta name="author" content="Drag13"><meta name="robots" content="index follow"><meta name="application-name" content="Drag13 Dev Blog"><link rel="stylesheet" href="https://drag13.io/common.fa446fe9.css"><style>.post .tag{color:var(--hashtag)}</style><link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://drag13.io/apple-touch-icon-144x144.f6d9dce4.png"><link rel="apple-touch-icon-precomposed" sizes="152x152" href="https://drag13.io/apple-touch-icon-152x152.5c0b4e01.png"><link rel="icon" type="image/png" href="https://drag13.io/favicon-32x32.2ff4c37a.png" sizes="32x32"><link rel="icon" type="image/png" href="https://drag13.io/favicon-16x16.60caff07.png" sizes="16x16"><link rel="manifest" crossorigin="use-credentials" href="https://drag13.io/manifest.webmanifest"><body><nav class="nav"><a class="link" href="/" title="Back to the main page">Home</a><div><a class="icon" href="https://github.com/Drag13" target="_blank" rel="noopener" title="Drag13 GitHub profile"><svg height="32" viewBox="0 0 16 16" width="32" aria-hidden="true"><path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/></svg></a><a class="icon" href="https://twitter.com/drag137" target="_blank" rel="noopener" title="Drag13 Twitter profile"><svg height="32" width="32" viewBox="0 0 24 24" aria-hidden="true" fill="rgba(29,161,242,1.00)"><path d="M23.643 4.937c-.835.37-1.732.62-2.675.733a4.67 4.67 0 002.048-2.578 9.3 9.3 0 01-2.958 1.13 4.66 4.66 0 00-7.938 4.25 13.229 13.229 0 01-9.602-4.868c-.4.69-.63 1.49-.63 2.342A4.66 4.66 0 003.96 9.824a4.647 4.647 0 01-2.11-.583v.06a4.66 4.66 0 003.737 4.568 4.692 4.692 0 01-2.104.08 4.661 4.661 0 004.352 3.234 9.348 9.348 0 01-5.786 1.995 9.5 9.5 0 01-1.112-.065 13.175 13.175 0 007.14 2.093c8.57 0 13.255-7.098 13.255-13.254 0-.2-.005-.402-.014-.602a9.47 9.47 0 002.323-2.41z"/></svg></a></div></nav><main class="main"><div class="content markdown-body"><article class="post"><h1>Performance testing on a slow network and weak CPU using Puppeteer and React</h1>
<p>In the <a href="https://drag13.io/posts/react-performance-puppeteer-profile">previous article</a> I've shown how to extract performance metrics from the React-based application using Puppeteer. We got ScriptDuration, Contentful Paint, Time To First Byte, Largest Contentful Paint, and other metrics. I also showed how to extract custom performance events using the <code>performance</code> API.</p>
<p>Today we will take a look into various testing conditions you might consider applying. We will set up the network limitations to simulate a slow 3g network, and we also will limit the CPU power to get a better understanding of how our application behaves on weak devices. Also, I will show how to test cache and cache-less scenarios to get performance metrics for the first visit and the next one. As an example, I will use the same React application as previously, however, this will work the same way for Angular, Vue, or classical website.</p>
<h2>Testing the application on a slow network</h2>
<p>While developing, we usually have pretty good equipment - fast and stable network, fast laptops with enough memory. However, this might do not apply to the end-users. As an example, according to the <a href="https://www.opensignal.com/sites/opensignal-com/files/data/reports/pdf-only/data-2020-05/state_of_mobile_experience_may_2020_opensignal_3_0.pdf">latest statistics</a>, mobile internet varies from 0.54MBit/s in Tanzania to 59.6MBit/s in Canada.</p>
<p>And this is something we might forget while developing. Thus, if your product will be used worldwide, performance testing with network limitations is more than crucial for you. Luckily it's a pretty easy task.</p>
<p>First of all, we need to define the network conditions that should be applied. Right now we can set up <code>downloadThroughput</code>, <code>uploadThroughput</code> and <code>latency</code>. For example, a slow 3g network will look something like this:</p>
<pre><code class="language-javascript"><span class="token keyword">const</span> slow3g <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">offline</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token literal-property property">downloadThroughput</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token number">0.4</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">8</span><span class="token punctuation">,</span>
  <span class="token literal-property property">uploadThroughput</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token number">0.4</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">8</span><span class="token punctuation">,</span>
  <span class="token literal-property property">latency</span><span class="token operator">:</span> <span class="token number">2000</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<p>The next step is to apply this configuration while testing. This task is also pretty simple and consists of 3 steps:</p>
<ul>
<li>Create CDP sesstion using <code>createCDPSession</code> (we will also reuse it for other purposes)</li>
<li>Turn ON network using <code>.send("Network.enable")</code></li>
<li>Send configuration using <code>.send("Network.emulateNetworkConditions", slow3g)</code></li>
</ul>
<p>Working example:</p>
<pre><code class="language-typescript"><span class="token comment">// create CDP session</span>
<span class="token keyword">const</span> pageSession <span class="token operator">=</span> <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">target</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createCDPSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// turn ON network</span>
<span class="token keyword">await</span> pageSession<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">"Network.enable"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// configure network</span>
<span class="token keyword">await</span> pageSession<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">"Network.emulateNetworkConditions"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  offline<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  downloadThroughput<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token number">0.4</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">8</span><span class="token punctuation">,</span>
  uploadThroughput<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token number">0.4</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">8</span><span class="token punctuation">,</span>
  latency<span class="token operator">:</span> <span class="token number">2000</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>Now, if you run <code>npm run e2e</code> you will see pretty many differences between the vanilla test and test with simulated 3g network:</p>
<table>
<thead>
<tr>
<th>Case</th>
<th>appRendered</th>
<th>FCP</th>
<th>lcp:</th>
<th>TaskDuration</th>
</tr>
</thead>
<tbody>
<tr>
<td>Original</td>
<td>82ms</td>
<td>123ms</td>
<td>139ms</td>
<td>0.068ms</td>
</tr>
<tr>
<td>Slow3g</td>
<td>5055ms</td>
<td>5087ms</td>
<td>7135ms</td>
<td>0.068ms</td>
</tr>
</tbody>
</table>
<p>As you can see, the appRendered metrics grew more than 61X. What is also worth mentioning, that TaskDuration metrics stay the same because we only limited the network and the compute power remains the same.</p>
<p>Of course, you may apply any network conditions (4g, WiFi) you feel are suitable for your product. Some extra examples can be found <a href="https://raw.githubusercontent.com/Drag13/perfrunner/master/packages/perfrunner-cli/src/config.ts">here</a>.</p>
<h2>Testing the application on with CPU throttling</h2>
<p>As you might already know, 55% of the page views in 2021 were done through mobile phones. Currently, the are around 5 280 000 000 mobile devices in use around the world. And most of them are not that powerful as a developer laptop. Frankly speaking, their CPU is pretty weak and comparable to the Octa-core 1.4 GHz Cortex-A53. This leads us to the situation when the application will work slowly with perfect network conditions because of intensive CPU operations like JS parsing, JS execution, force reflows, and such other expensive stuff.</p>
<p>And of course, there are a bunch of cheap or outdated laptops that you also might want to cover. This leads us to the importance of testing for the weak CPU conditions, and the good news is that this is an even easier task than the previous.</p>
<p>All you need is to set throttling rate using <code>pageSession.send('Emulation.setCPUThrottlingRate', config}</code>. The only possible caveat is - not possible to set up exact CPU power (frequency, cache, etc), you can only throttle your current CPU in 2-3-4-X times:</p>
<pre><code class="language-ts">await pageSession.send("Emulation.setCPUThrottlingRate", { rate: 4 });
</code></pre>
<p>Test results with the throttling will look like this:</p>
<table>
<thead>
<tr>
<th>Case</th>
<th>appRendered</th>
<th>FCP</th>
<th>lcp:</th>
<th>TaskDuration</th>
</tr>
</thead>
<tbody>
<tr>
<td>Original</td>
<td>82ms</td>
<td>123ms</td>
<td>139ms</td>
<td>0.068ms</td>
</tr>
<tr>
<td>Slow3g</td>
<td>5055ms</td>
<td>5087ms</td>
<td>7135ms</td>
<td>0.068ms</td>
</tr>
<tr>
<td>Slow3g+CPUx4</td>
<td>5201ms</td>
<td>5325ms</td>
<td>7336ms</td>
<td>0.332ms</td>
</tr>
</tbody>
</table>
<p>Note that TaskDuration timing increased 4.9 times which naturally affects all other metrics.</p>
<h2>Testing the application with and without caching</h2>
<p>Before this point, we worked with the cacheless scenario. However, this was done unintentionally - we used a new browser instance for each test. In the real world, you might want to run a series of tests and it might be beneficial if we could control caching strategy. For this purposes, Puppeteer has special API - <code>setChacheEnabled</code> and <code>Network.setCacheDisabled</code> command. Altogether this looks like this:</p>
<pre><code class="language-ts">await page.setCacheEnabled(false);
await pageSession.send("Network.setCacheDisabled", { cacheDisabled: true });
</code></pre>
<p>Now you can dictate to the browser use cache or not. That's it, pretty simple, yeah? If you want to test application performance with cache - just do the extra load without measuring and then do regular testing.</p>
<p>One more note - sometimes you might see huge differences between the first and others test runs. In this case, I would recommend executing a single page load to "warm-up" the browser before testing. This slightly increases overall test duration however might produce more accurate results.</p>
<h2>Summary</h2>
<p>Today I've shown how to measure web application performance in various conditions - weak network conditions, slow CPU, and disabling the browser cache. As you can see, this is absolutely doable and might bring you some extra insights about your solution. For the complete example, please take a look into the <a href="https://github.com/Drag13/react-performance-puppeteer-profile">example repo</a>. If you have any questions - feel free to contact me via <a href="https://twitter.com/drag137">Twitter</a></p>
<p>Cya!</p>
<p class="tag">11.11.2021 #performance-testing, #web-testing, #puppeteer, #react, #slow-network, #webvitals</p></article></div></main><footer class="footer"><a href="https://github.com/Drag13/drag13.github.io/blob/development/LICENSE" rel="noopener" target="_blank" title="License">2023 MIT by Drag13</a></footer></body></html>