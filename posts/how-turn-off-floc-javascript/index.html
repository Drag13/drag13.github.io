<!DOCTYPE html><html lang="en" prefix="og: http://ogp.me/ns#"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'none'; object-src 'none'"><title>Turning FLoC off using JavaScript</title><meta property="og:title" content="Turning FLoC off using JavaScript"><meta name="description" content="Federated Learning of Cohorts (FLoC) - is the new way proposed by Google that allows Chrome to collect and share customer's personal information without the need for cookies. This article describes how to opt-out FLoC using JavaScript and why HTTP headers might not be enough"><meta property="og:description" content="Federated Learning of Cohorts (FLoC) - is the new way proposed by Google that allows Chrome to collect and share customer's personal information without the need for cookies. This article describes how to opt-out FLoC using JavaScript and why HTTP headers might not be enough"><meta name="keywords" content="floc, chrome, javascript, webdevelopment, websecurity, privacy, intersectcohort, floc-off, floc-optout, permission-policy, turn-off-floc"><link rel="canonical" href="https://drag13.io/posts/how-turn-off-floc-javascript/index.html"><meta property="og:url" content="https://drag13.io/posts/how-turn-off-floc-javascript/index.html"><meta property="og:type" content="website"><meta name="twitter:card" content="summary"><meta name="twitter:site" content="https://twitter.com/drag137"><meta name="twitter:url" content="https://drag13.io/posts/how-turn-off-floc-javascript/index.html"><meta name="twitter:title" content="Turning FLoC off using JavaScript"><meta name="twitter:description" content="Federated Learning of Cohorts (FLoC) - is the new way proposed by Google that allows Chrome to collect and share customer's personal information without the need for cookies. This article describes how to opt-out FLoC using JavaScript and why HTTP headers might not be enough"><meta name="og:site_name" content="Drag13 Dev Blog"><meta property="og:image" content="https://drag13.io/how-to-optout-floc.d5232a4a.png"><meta name="twitter:image" content="https://drag13.io/how-to-optout-floc.d5232a4a.png"><meta name="application-name" content="Drag13 programmer's blog"><meta name="author" content="Drag13"><meta name="robots" content="index follow"><meta name="application-name" content="Drag13 Dev Blog"><link rel="stylesheet" href="https://drag13.io/common.7962633b.css"><style>code[class*=language-],pre[class*=language-]{color:#000;background:none;text-shadow:0 1px #fff;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}code[class*=language-]::-moz-selection,code[class*=language-] ::-moz-selection,pre[class*=language-]::-moz-selection,pre[class*=language-] ::-moz-selection{text-shadow:none;background:#b3d4fc}code[class*=language-]::selection,code[class*=language-] ::selection,pre[class*=language-]::selection,pre[class*=language-] ::selection{text-shadow:none;background:#b3d4fc}@media print{code[class*=language-],pre[class*=language-]{text-shadow:none}}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#f5f2f0}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#708090}.token.punctuation{color:#999}.token.namespace{opacity:.7}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#905}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#690}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url{color:#9a6e3a;background:hsla(0,0%,100%,.5)}.token.atrule,.token.attr-value,.token.keyword{color:#07a}.token.class-name,.token.function{color:#dd4a68}.token.important,.token.regex,.token.variable{color:#e90}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.post .tag{color:#757575}</style><link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://drag13.io/apple-touch-icon-144x144.f6d9dce4.png"><link rel="apple-touch-icon-precomposed" sizes="152x152" href="https://drag13.io/apple-touch-icon-152x152.5c0b4e01.png"><link rel="icon" type="image/png" href="https://drag13.io/favicon-32x32.2ff4c37a.png" sizes="32x32"><link rel="icon" type="image/png" href="https://drag13.io/favicon-16x16.60caff07.png" sizes="16x16"><link rel="manifest" crossorigin="use-credentials" href="https://drag13.io/manifest.webmanifest"><body><nav class="nav"><a class="link" href="/" title="Back to the main page">Home</a><div><a class="icon" href="https://github.com/Drag13" target="_blank" rel="noopener" title="Drag13 GitHub profile"><svg height="32" viewBox="0 0 16 16" width="32" aria-hidden="true"><path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/></svg></a><a class="icon" href="https://twitter.com/drag137" target="_blank" rel="noopener" title="Drag13 Twitter profile"><svg height="32" width="32" viewBox="0 0 24 24" aria-hidden="true" fill="rgba(29,161,242,1.00)"><path d="M23.643 4.937c-.835.37-1.732.62-2.675.733a4.67 4.67 0 002.048-2.578 9.3 9.3 0 01-2.958 1.13 4.66 4.66 0 00-7.938 4.25 13.229 13.229 0 01-9.602-4.868c-.4.69-.63 1.49-.63 2.342A4.66 4.66 0 003.96 9.824a4.647 4.647 0 01-2.11-.583v.06a4.66 4.66 0 003.737 4.568 4.692 4.692 0 01-2.104.08 4.661 4.661 0 004.352 3.234 9.348 9.348 0 01-5.786 1.995 9.5 9.5 0 01-1.112-.065 13.175 13.175 0 007.14 2.093c8.57 0 13.255-7.098 13.255-13.254 0-.2-.005-.402-.014-.602a9.47 9.47 0 002.323-2.41z"/></svg></a></div></nav><main class="main"><div class="content markdown-body"><article class="post"><h1>How to opt-out Federated Learning of Cohorts (FLoC) using JavaScript</h1>
<p><img src="https://drag13.io/how-to-optout-floc.d5232a4a.png" alt="how to turn off FLoC using JavaScript"></p>
<h2>Federated Learning of Cohorts and default way to opt-out</h2>
<p>Federated Learning of Cohorts (FLoC) - is the <a href="https://github.com/WICG/floc">new way proposed by Google</a> that allows Chrome to collect and share customers' personal information without the need for cookies. It uses the browser's history (which had never opened) and some other methods to group people into cohorts based on their interests and show them some ads which raise <a href="https://www.eff.org/ru/deeplinks/2021/03/googles-floc-terrible-idea">some questions</a> about privacy.</p>
<p>Introducing this technology, Google states that <a href="https://github.com/WICG/floc#privacy-and-security-considerations">FLoC will keep your privacy</a>, however some <a href="https://brave.com/why-brave-disables-floc/">concerns</a> still exists. To give an option to fix this, Google provides the way to opt-out of the FLoC by using HTTP Header <code>Permissions-Policy</code> with the value <code>interest-cohort=()</code>.</p>
<p>Unfortunately, this solution has a few issues:</p>
<ul>
<li>Sometimes, you are not able to manipulate HTTP headers at all. As an example - using GitHub Pages, you are not able to set any custom HTTP header. Recently, GitHub added <code>Permissions-Policy</code> but only for the github.com domain. Disabling FLoC for GitHub pages with custom domains is still impossible (<code>meta-equiv</code> is not working for the <code>Permissions-Policy</code>).</li>
<li>The second issue is much more controversial, however, it's still not null. The fact is that the mechanism of turning FLoC on/off belongs to the organization with one of the highest <a href="https://abc.xyz/investor/static/pdf/2019Q4_alphabet_earnings_release.pdf?cache=79552b8">income</a> comes from the ad. It's is not bad, but this means that at some point, Google may decide to change the mechanism turning FLoC off, ignore it or even remove it. I am not stating this will happen, but this seems possible.</li>
</ul>
<p>Such circumstances lead us to the necessity to have another way to turn FLoC off, and JavaScript is a perfect candidate.</p>
<h2>How to Turn OFF FLoC using the JavaScript</h2>
<p>Luckily in the Web world, we can change a lot of things, and FLoC API is one of them. The <code>document.interestCohort()</code> method should be called when someone needs to get the user's cohort. This method exists in the <code>Document</code> prototype and can be overridden. If you get the descriptor of this property using <code>Object.getOwnPropertyDescriptor</code>, you should notice that it is writable, and we can substitute this property.</p>
<p>Thus, an algorithm looks pretty simple:</p>
<ul>
<li>Check if <code>interestCohort</code> API supported</li>
<li>If yes and rewriting is possible</li>
<li>
<ul>
<li>Create a proxy that will return rejected promise</li>
</ul>
</li>
<li>
<ul>
<li>Substitute the original function with a newly created proxy</li>
</ul>
</li>
<li>
<ul>
<li>Disable reconfiguring of the interestCohort property to disable recovering</li>
</ul>
</li>
<li>If no - do nothing</li>
</ul>
<p>In JavaScript, this might look something like this:</p>
<pre><code class="language-js"><span class="token keyword">const</span> cohorts <span class="token operator">=</span> <span class="token string">"interestCohort"</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> documentProto <span class="token operator">=</span> <span class="token class-name">Document</span><span class="token punctuation">.</span>prototype<span class="token punctuation">;</span>
<span class="token keyword">const</span> flocSupported <span class="token operator">=</span> cohorts <span class="token keyword">in</span> documentProto<span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>flocSupported<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> descriptor <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">getOwnPropertyDescriptor</span><span class="token punctuation">(</span>documentProto<span class="token punctuation">,</span> cohorts<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> writable <span class="token operator">=</span> descriptor <span class="token operator">&amp;&amp;</span> descriptor<span class="token punctuation">.</span>writable<span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>writable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>documentProto<span class="token punctuation">[</span>cohorts<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token function-variable function">apply</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token punctuation">{</span>
    writable<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    value<span class="token operator">:</span> proxy<span class="token punctuation">,</span>
    configurable<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    enumerable<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>documentProto<span class="token punctuation">,</span> cohorts<span class="token punctuation">,</span> config<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>You can find the full version <a href="https://github.com/Drag13/floc-off/blob/master/src/index.js">here</a>.</p>
<p>Of course, we can completely remove this method from the Document prototype, but this may lead to errors for those who use it, so I suggest faking it instead of deleting it.</p>
<h2>Use case</h2>
<p>I found two cases when using this technic might be helpful.</p>
<ul>
<li>You are not able to add HTTP headers. GitHub Pages for a custom domain is a perfect example for now. This <a href="https://twitter.com/drag137/status/1387425202125033476">will change</a>, I believe, but now you can disable FLoC only using JavaScript.</li>
<li>You don't trust that putting the Permissions-Policy HTTP header will prevent getting the user's data (as it was with the Do Not Track header).</li>
<li>You simply dislike Google ðŸ˜ˆ</li>
</ul>
<p>For those who found these points reasonable, I wrote the tiny npm package named - <a href="https://www.npmjs.com/package/floc-off">floc-off</a>. It's minimal (287 bytes) and safe to use.
Just install it using <code>npm i floc-off</code> and import it at the top of your entry file:</p>
<p>"`javascript
import "floc-off";</p>
<pre><code>
That's it. The code is open-source and can be found in my [GitHub](https://github.com/Drag13/floc-off)

As for my blog - I've disabled JavaScript completely using the [Content-Security-Policy](https://drag13.io/posts/security-headers/index.html), so your privacy is already safe here ðŸ˜Š

## Another opinion

I also couldn't omit to mention another opinion about how to turn off the FLoC, described [in this article](https://seirdy.one/2021/04/16/permissions-policy-floc-misinfo.html) by Rohan Kumar. This article proposes a better option to turn off the FLoC:

- Don't load untrusted third-party content that might get classified as an ad (only applies during the origin trial)
- Don't call document.interestCohort(), and don't load third-party scripts that might call it either.

Which is basically fair and will work in an ideal world. However, in the real world, you may have the Google Tag Manager script, some scripts from partners, or anything else that is out of your control. And yes, having all of this, you may still want to turn off the FLoC. Using ads doesn't automatically means that you allow them to show this ugly popup jumping right into the user's face, right? This case is similar - I still want to show ads, but I don't want to breach the user's privacy. For this case, this package can also help.
</code></pre>
<p class="tag">[05.05.2021] #FLoC #Chrome #JavaScript #WebDevelopment #Web #Security #Privacy</p></article></div></main><footer class="footer"><a href="https://github.com/Drag13/drag13.github.io/blob/development/LICENSE" rel="noopener" target="_blank" title="License">2022 MIT by Drag13</a></footer></body></html>