<!DOCTYPE html><html lang="en" prefix="og: http://ogp.me/ns#"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'none'; object-src 'none'; style-src: 'self' 'unsafe-inline'"><title>Getting performance metrics using Puppeteer and React</title><meta property="og:title" content="Getting performance metrics using Puppeteer and React"><meta name="description" content="How to gather web-vitals performance metrics like LargestContentfulPaint and TimeToFirstByte from React-based application using Puppeteer with examples"><meta property="og:description" content="How to gather web-vitals performance metrics like LargestContentfulPaint and TimeToFirstByte from React-based application using Puppeteer with examples"><meta name="keywords" content="react.js, react, profile, performance metrics, corewebvitals, webvitals, FirstInputDelay, CumulativeLayoutShift, LargestContentfulPaint, ScriptDuration, puppeteer,custom performance event, webvitals, CumulativeLayoutShift, perfmetters"><link rel="canonical" href="https://drag13.io/posts/react-performance-puppeteer-profile/index.html"><meta property="og:url" content="https://drag13.io/posts/react-performance-puppeteer-profile/index.html"><meta property="og:type" content="website"><meta name="twitter:card" content="summary"><meta name="twitter:site" content="https://twitter.com/drag137"><meta name="twitter:url" content="https://drag13.io/posts/react-performance-puppeteer-profile/index.html"><meta name="twitter:title" content="Getting performance metrics using Puppeteer and React"><meta name="twitter:description" content="How to gather web-vitals performance metrics like LargestContentfulPaint and TimeToFirstByte from React-based application using Puppeteer with examples"><meta name="og:site_name" content="Drag13 Dev Blog"><meta property="og:image" content="https://drag13.io/react-performance-puppeteer-profile-kdpv.d850c2c2.jpg"><meta name="twitter:image" content="https://drag13.io/react-performance-puppeteer-profile-kdpv.d850c2c2.jpg"><meta name="application-name" content="Drag13 programmer's blog"><meta name="author" content="Drag13"><meta name="robots" content="index follow"><meta name="application-name" content="Drag13 Dev Blog"><link rel="stylesheet" href="https://drag13.io/common.7962633b.css"><style>code[class*=language-],pre[class*=language-]{color:#000;background:none;text-shadow:0 1px #fff;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}code[class*=language-]::-moz-selection,code[class*=language-] ::-moz-selection,pre[class*=language-]::-moz-selection,pre[class*=language-] ::-moz-selection{text-shadow:none;background:#b3d4fc}code[class*=language-]::selection,code[class*=language-] ::selection,pre[class*=language-]::selection,pre[class*=language-] ::selection{text-shadow:none;background:#b3d4fc}@media print{code[class*=language-],pre[class*=language-]{text-shadow:none}}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#f5f2f0}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#708090}.token.punctuation{color:#999}.token.namespace{opacity:.7}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#905}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#690}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url{color:#9a6e3a;background:hsla(0,0%,100%,.5)}.token.atrule,.token.attr-value,.token.keyword{color:#07a}.token.class-name,.token.function{color:#dd4a68}.token.important,.token.regex,.token.variable{color:#e90}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.post .tag{color:#757575}</style><link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://drag13.io/apple-touch-icon-144x144.f6d9dce4.png"><link rel="apple-touch-icon-precomposed" sizes="152x152" href="https://drag13.io/apple-touch-icon-152x152.5c0b4e01.png"><link rel="icon" type="image/png" href="https://drag13.io/favicon-32x32.2ff4c37a.png" sizes="32x32"><link rel="icon" type="image/png" href="https://drag13.io/favicon-16x16.60caff07.png" sizes="16x16"><link rel="manifest" crossorigin="use-credentials" href="https://drag13.io/manifest.webmanifest"><body><nav class="nav"><a class="link" href="/" title="Back to the main page">Home</a><div><a class="icon" href="https://github.com/Drag13" target="_blank" rel="noopener" title="Drag13 GitHub profile"><svg height="32" viewBox="0 0 16 16" width="32" aria-hidden="true"><path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/></svg></a><a class="icon" href="https://twitter.com/drag137" target="_blank" rel="noopener" title="Drag13 Twitter profile"><svg height="32" width="32" viewBox="0 0 24 24" aria-hidden="true" fill="rgba(29,161,242,1.00)"><path d="M23.643 4.937c-.835.37-1.732.62-2.675.733a4.67 4.67 0 002.048-2.578 9.3 9.3 0 01-2.958 1.13 4.66 4.66 0 00-7.938 4.25 13.229 13.229 0 01-9.602-4.868c-.4.69-.63 1.49-.63 2.342A4.66 4.66 0 003.96 9.824a4.647 4.647 0 01-2.11-.583v.06a4.66 4.66 0 003.737 4.568 4.692 4.692 0 01-2.104.08 4.661 4.661 0 004.352 3.234 9.348 9.348 0 01-5.786 1.995 9.5 9.5 0 01-1.112-.065 13.175 13.175 0 007.14 2.093c8.57 0 13.255-7.098 13.255-13.254 0-.2-.005-.402-.014-.602a9.47 9.47 0 002.323-2.41z"/></svg></a></div></nav><main class="main"><div class="content markdown-body"><article class="post"><h1>How to get performance metrics and web vitals using Puppeteer, React and TypeScript, Part 1</h1>
<p><img src="https://drag13.io/react-performance-puppeteer-profile-kdpv.d850c2c2.jpg" alt="How to get performance metrics and web vitals using Puppeteer, React and TypeScript, part 1"></p>
<p>In this article, I will demonstrate how to build the script to automate gathering performance metrics like First Contentful Paint and Core Web Vitals from the React-based application using Puppeteer and TypeScript. I will also describe how to create and extract your own performance events using the React Profiler component. This might be useful if you decide to do some performance research or implement advanced performance testing into your CI/CD pipeline.</p>
<h2>The Plan</h2>
<p>Because of the large amount of material and code, I will split the content into two parts. The first one (this one) will be about gathering performance metrics and the second one will be about various test conditions like CPU and network. Here are the main points I will cover:</p>
<p>Part #1:</p>
<ul>
<li>Create a new React.JS project and install required dependencies for performance measuring</li>
<li>Extract ScriptDuration, LayoutDuration, JSHeapUsedSize, and other metrics provided by Puppeteer API</li>
<li>Extract First Contentful Paint and Time to First Byte from performance events</li>
<li>Extract Largest Contentful Paint using the PerformanceObserver API</li>
<li>Use web-vitals library to get Core Web Vitals metrics</li>
<li>Emit and extract custom performance event using performance API and React Profiler component</li>
</ul>
<p>Part #2:</p>
<ul>
<li>Change network and CPU conditions</li>
<li>Cached and No-Cache strategy</li>
<li>Emulating different devices</li>
<li>Final wrap up</li>
</ul>
<h2>Initial setup with React.JS and Puppeteer</h2>
<p>First, we need to prepare the workspace. You can use an already existed application (better to take something React-based if you want to use Profiler component, however, all code will work for Angular, Vue, or vanilla JS application) or create something from scratch. Also, you will need to install some extra dependencies to be able to profile the application. You can also clone the <a href="https://github.com/Drag13/react-performance-puppeteer-profile">demo repository</a> and use it directly.</p>
<p>Install the application, <a href="https://www.npmjs.com/package/puppeteer">puppeteer</a> for running tests, <a href="https://www.npmjs.com/package/serve">serve</a> to host the application, <a href="https://www.npmjs.com/package/start-server-and-test">start-server-and-test</a> to automate launching the application, <a href="https://www.typescriptlang.org/">TypeScript</a> and <a href="https://www.npmjs.com/package/ts-node">ts-node</a> to run the written script. If you already using TypeScript in your project - install only the ts-node.</p>
<pre><code class="language-cmd">npx create-react-app perf
<span class="token builtin class-name">cd</span> perf
<span class="token function">npm</span> i puppeteer serve ts-node typescript start-server-and-test -O
</code></pre>
<p>Note, that I am using the <code>-O</code> flag to install performance-related dependencies as optional. This gives me the possibility to skip them using <code>npm ci --no-optional</code> command for the scenarios where they are not needed and saves me some build time.</p>
<p>Now create the new folder named e2e and put an empty index.ts file. Update the <code>package.json</code> with next scripts:</p>
<pre><code class="language-json"><span class="token property">"scripts"</span><span class="token operator">:</span><span class="token punctuation">{</span>
    <span class="token property">"serve"</span><span class="token operator">:</span> <span class="token string">"serve ./build"</span><span class="token punctuation">,</span>
    <span class="token property">"ts-node"</span><span class="token operator">:</span> <span class="token string">"ts-node"</span><span class="token punctuation">,</span>
    <span class="token property">"tsc"</span><span class="token operator">:</span> <span class="token string">"tsc"</span><span class="token punctuation">,</span>
    <span class="token property">"e2e:run"</span><span class="token operator">:</span> <span class="token string">"ts-node --project e2e/tsconfig.json --files e2e/index.ts"</span> <span class="token punctuation">,</span>
    <span class="token property">"e2e"</span><span class="token operator">:</span> <span class="token string">"start-server-and-test serve http://localhost:5000 e2e:run"</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Initialize new tsconfig file with <code>npm run tsc -- --init</code>, <strong>put it into the e2e folder</strong> and build the application using <code>npm run build</code>. Now launch the application using <code>npm e2e</code> command. At this point, your application will start and empty index.ts executed without any result. Time to fill it with some code!</p>
<h2>How to get default performance metrics from the Puppeteer</h2>
<p>Getting some of the performance metrics like script duration, heap size, and couple of others is really simple because of the API that already provided by the Puppeteer. The algorithm is simple - using Puppeteer we are launching Chrome, then navigating to the page we want to profile, wait for the load, and finally, dump required metrics. From the code perspective it will look like this:</p>
<pre><code class="language-typescript"><span class="token keyword">import</span> <span class="token punctuation">{</span> launch <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"puppeteer"</span><span class="token punctuation">;</span>

<span class="token comment">// url to inspect</span>
<span class="token keyword">const</span> pageUrl <span class="token operator">=</span> <span class="token string">"http://localhost:5000"</span><span class="token punctuation">;</span>

<span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>url<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> browser<span class="token punctuation">;</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment">// launch the Chrome browser without Sandbox (might help if puppeteer not working)</span>
    browser <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">launch</span><span class="token punctuation">(</span><span class="token punctuation">{</span> product<span class="token operator">:</span> <span class="token string">"chrome"</span><span class="token punctuation">,</span> args<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"--no-sandbox"</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// launch the page</span>
    <span class="token keyword">const</span> page <span class="token operator">=</span> <span class="token keyword">await</span> browser<span class="token punctuation">.</span><span class="token function">newPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// navigate to the url and wait untill all network activity stops</span>
    <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">goto</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token punctuation">{</span> waitUntil<span class="token operator">:</span> <span class="token string">"networkidle0"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// dump page metrics</span>
    <span class="token keyword">const</span> metrics <span class="token operator">=</span> <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">metrics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>metrics<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
    <span class="token comment">// close the browser correctly even if something went wrong</span>
    browser <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token keyword">await</span> browser<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>pageUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>The output will look like this:</p>
<pre><code class="language-js"><span class="token punctuation">{</span>
  Timestamp<span class="token operator">:</span> <span class="token number">20956.347834</span><span class="token punctuation">,</span>
  Documents<span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
  Frames<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
  JSEventListeners<span class="token operator">:</span> <span class="token number">136</span><span class="token punctuation">,</span>
  Nodes<span class="token operator">:</span> <span class="token number">51</span><span class="token punctuation">,</span>
  LayoutCount<span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
  RecalcStyleCount<span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
  LayoutDuration<span class="token operator">:</span> <span class="token number">0.021509</span><span class="token punctuation">,</span>
  RecalcStyleDuration<span class="token operator">:</span> <span class="token number">0.000924</span><span class="token punctuation">,</span>
  ScriptDuration<span class="token operator">:</span> <span class="token number">0.01118</span><span class="token punctuation">,</span>
  TaskDuration<span class="token operator">:</span> <span class="token number">0.054886</span><span class="token punctuation">,</span>
  JSHeapUsedSize<span class="token operator">:</span> <span class="token number">2377752</span><span class="token punctuation">,</span>
  JSHeapTotalSize<span class="token operator">:</span> <span class="token number">3198976</span>
<span class="token punctuation">}</span>
</code></pre>
<p>There are 13 different metrics but the most interesting are:</p>
<ul>
<li>ScriptDuration - the amount of time in milliseconds how much time the browser spent on javascript <strong>parsing</strong> and <strong>executing</strong>. If numbers here really big this means that you have either the big amount of JavaScript on the page or it runs too much, and you should consider code splitting. For the mobiles from low segments, a huge* amount of JavaScript may be a pure disaster because parsing JavaScript is not something simple. Even if you have very fast internet, JavaScript still may block content from rendering or increase time to interact.</li>
<li>LayoutDuration - the amount of time in milliseconds how much time the browser spent on construction layout. If it starts rapidly growing, this signalizes that your markup is overcomplicated or big.</li>
<li>JSHeapUsedSize - the amount of memory in bytes the application is using. Again, this is important for the cheap mobiles that have a little amount of memory. If you are targeting this audience this metric is crucial for you.</li>
</ul>
<p>Other metrics are also useful (notice RecalcStyleCount), but let's skip them at this tutorial.</p>
<p>*Regarding the <a href="https://infrequently.org/2021/03/the-performance-inequality-gap/">latest researches</a> done in the 2021 year current budget for mobile devices is about <strong>100KiB of HTML/CSS/fonts and ~300-350KiB of JS</strong>. This is bigger than we have previously but still not much, thus if you see 1MB of gzipped JavaScript it's time for some questions 🤔</p>
<p>However, already gathered data not even close to the list we want to have. The most popular metrics like First Contentful Paint, Largest Contentful Paint, and Time to Interactive missing. We need to go deeper.</p>
<h2>How to get First Contentful Paint</h2>
<p>The First Contentful Paint event is part of the Web Vitals performance events and indicates when a user starts seeing any part of the content (text, image, canvas, etc.). Recommended value is 1.8 seconds. To get this metric we will use the browser's <code>performance</code> API:</p>
<pre><code class="language-typescript"><span class="token comment">// Get performance entries</span>
<span class="token keyword">const</span> rawPerfEntries <span class="token operator">=</span> <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">evaluate</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>performance<span class="token punctuation">.</span><span class="token function">getEntries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Parsing string</span>
<span class="token keyword">const</span> allPerformanceEntries <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>rawPerfEntries<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Find FirstContentfulPaing</span>
<span class="token keyword">const</span> fcp <span class="token operator">=</span> allPerformanceEntries<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">"first-contentful-paint"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>fcp<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>The variable <code>allPerformanceEntries</code> will contain the array with most (but not all) performance events that happened on the page. If you explore this array, you will see:</p>
<ul>
<li>Navigation event (get it using <code>.find(x=&gt;x.entryType ==='navigation')</code>). This event contains such important timings like <code>domComplete</code>, <code>domContentLoadedEventEnd</code>, <code>domainLookupStart</code>, <code>domainLookupEnd</code> and others. It also contains server timings if your server supports them. For this example, I will use this entry to get one of the webvitals metrics - Time to First Byte.</li>
<li>All timings related to each, and every resource fetched by the page. This mean you can find information about how much time it took to download your bundle or styles or calculate the size of the resources - might be useful if you want to track resources size.</li>
<li>All custom performance events were logged by the application. This is extremely useful and important functionality, I will write about it a bit later.</li>
</ul>
<p>Now let's write some code and extract the Time To First Byte event (to me it already starts sounds like a quest)</p>
<p>Create the new file <code>performance-entries.ts</code> with next code:</p>
<pre><code class="language-typescript"><span class="token comment">/*Gets Time To First Byte metric*/</span>
<span class="token keyword">function</span> <span class="token function">getTTFB</span><span class="token punctuation">(</span>entries<span class="token operator">:</span> PerformanceEntry<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> navigationEvent <span class="token operator">=</span> entries<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span>entryType <span class="token operator">===</span> <span class="token string">"navigation"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> PerformanceNavigationTiming<span class="token punctuation">;</span>
  <span class="token keyword">return</span> navigationEvent<span class="token punctuation">.</span>responseStart <span class="token operator">??</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Now, let's talk about the core web vitals and new PerformanceObserver API that can give us even more data to analyze.</p>
<h2>Core Web Vitals and PerformanceObserver API</h2>
<p>Might be you already heard about the <a href="https://web.dev/vitals/#core-web-vitals">Core Web Vitals</a> - user centric performance metrics that reflect the real-world experience of a critical part of the user experience. In 2021 (the list is a subject to change I believe) they are:</p>
<ul>
<li>Largest Contentful Paint measures loading performance. To provide a good user experience, LCP should occur within 2.5 seconds of when the page first starts loading.</li>
<li>First Input Delay: measures interactivity. To provide a good user experience, pages should have an FID of less than 100 milliseconds.</li>
<li>Cumulative Layout Shift: measures visual stability. To provide a good user experience, pages should maintain a CLS of less than 0.1.</li>
</ul>
<p>Right now, we didn't spot them yet and, unfortunately, the puppeteer has no API to get them simply. However we still are able to retrieve them either using <a href="https://developer.mozilla.org/en-US/docs/Web/API/PerformanceObserver">PerformanceObserver</a> API or using <a href="https://github.com/GoogleChrome/web-vitals">web-vitals</a> library that already comes with the new React applications. Today I will show both ways, but please be aware that measuring Core Web Vitals manually is more complex than at the example.</p>
<p>To get Largest Contenful Paint or other metrics from the Core Web Vitals we will use new PerformanceObserver API. It is used ot observe (receive and process) performance events that comes from the browser. The simplest example will be look like this:</p>
<pre><code class="language-typescript"><span class="token keyword">function</span> <span class="token function">installLCPObserver</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> lcpObserver <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PerformanceObserver</span><span class="token punctuation">(</span><span class="token punctuation">(</span>entryList<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    entryList<span class="token punctuation">.</span><span class="token function">getEntries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> lastEntry <span class="token operator">=</span> entries<span class="token punctuation">[</span>entries<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>lastEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  lcpObserver<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">"largest-contentful-paint"</span><span class="token punctuation">,</span> buffered<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>However, to make it work in a real life we will have to make it more <a href="https://web.dev/lcp/#differences-between-the-metric-and-the-api">complex</a></p>
<p>Firstly, inside the e2e folder (this is important!) create new folder named <code>typings</code> and put there index.d.ts file with next content:</p>
<pre><code class="language-typescript"><span class="token keyword">declare</span> <span class="token keyword">interface</span> <span class="token class-name">Window</span> <span class="token punctuation">{</span>
  _pe<span class="token operator">:</span> PerformanceEntry<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>This code will extend extend <code>window</code> with the new property and fix TypeScript errors. This technique described in my previous article - <a href="https://drag13.io/posts/typescript-tips-tricks-declarations/index.html">TypeScript Tips and Tricks - Declarations With Examples</a>. But for ts-node <a href="https://github.com/TypeStrong/ts-node/issues/782">this is not enough</a>, ts-node will not pickup the custom typings unless you specify the <code>--files</code> options like I did in package.json.</p>
<p>Then we need to install Performance Observer and store the performance results. Create new file named <code>lcp.ts</code> and put there:</p>
<pre><code class="language-typescript"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">setupPerfromanceScripts</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// we will store the data here</span>
  window<span class="token punctuation">.</span>_pe <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token comment">// install LCP obeserver</span>
  <span class="token keyword">function</span> <span class="token function">installLCPObserver</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> lcpObserver <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PerformanceObserver</span><span class="token punctuation">(</span><span class="token punctuation">(</span>entryList<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> entries <span class="token operator">=</span> entryList<span class="token punctuation">.</span><span class="token function">getEntries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> lastEntry <span class="token operator">=</span> entries<span class="token punctuation">[</span>entries<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

      <span class="token comment">// store the last found entry</span>
      window<span class="token punctuation">.</span>_pe<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>lastEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// start observing</span>
    lcpObserver<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">"largest-contentful-paint"</span><span class="token punctuation">,</span> buffered<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> lcpObserver<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> lcpObserver <span class="token operator">=</span> <span class="token function">installLCPObserver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// save data and disconnect in case page become hidden</span>
  document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">"visibilitychange"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>document<span class="token punctuation">.</span>visibilityState <span class="token operator">===</span> <span class="token string">"hidden"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      lcpObserver<span class="token punctuation">.</span><span class="token function">takeRecords</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      lcpObserver<span class="token punctuation">.</span><span class="token function">disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>The last point is to extract stored data:</p>
<pre><code class="language-typescript"><span class="token keyword">import</span> <span class="token punctuation">{</span> Page <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"puppeteer"</span><span class="token punctuation">;</span>

<span class="token comment">// extracts all web vitals</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">extractWebVitals</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">function</span> <span class="token function">extractLCP</span><span class="token punctuation">(</span>entries<span class="token operator">:</span> PerformanceEntry<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> allLcp <span class="token operator">=</span> entries<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span>entryType <span class="token operator">===</span> <span class="token string">"largest-contentful-paint"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> allLcp<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">?</span> allLcp<span class="token punctuation">[</span>allLcp<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>startTime <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// ignores DOM elements when serializing to avoid recursion</span>
  <span class="token keyword">const</span> <span class="token function-variable function">safeParser</span> <span class="token operator">=</span> <span class="token punctuation">(</span>key<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> val<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>key <span class="token operator">===</span> <span class="token string">"element"</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> lcp <span class="token operator">=</span> <span class="token function">extractLCP</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>_pe<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span> lcp<span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>lcp<span class="token punctuation">,</span> safeParser<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">extractWebVitals</span><span class="token punctuation">(</span>page<span class="token operator">:</span> Page<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">evaluate</span><span class="token punctuation">(</span>extractMetrics<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>This code is quite simple but have a few tricks:</p>
<ul>
<li>I didn't use <code>find</code> as previous, because several <code>largest-contentful-paint</code> events are expected, we need the last one</li>
<li>I have to wrote <code>safeParser</code> method because to avoid serializing ciruclar dependencies</li>
<li>I put all code into the one function to avoid evaluation exception from puppeteer</li>
</ul>
<p>The same way you can implement getting other Core Web Vitals - <a href="https://web.dev/fid/#measure-fid-in-javascript">First Input Delay</a> and <a href="https://web.dev/cls/#measure-cls-in-javascript">Cumulative Layout Shift</a>.</p>
<p>However, these examples have some gaps. Google team warns that measuring Core Web Vitals is more complex and you might spot some pitfalls, thus you might decide to use <a href="https://github.com/GoogleChrome/web-vitals">web-vitals</a> library for better precision.</p>
<h2>How to use use web-vitals library to get Core Web Vitals metrics</h2>
<p>If you are using the latest version of the create-react-app, the web-vitals library already injected into your index.tsx file and almost ready to work. If you don't have it, please look into the <a href="https://github.com/Drag13/react-performance-puppeteer-profile/blob/master/src/index.js">demo repository</a> for the example.</p>
<p>The next step is to provide a function that will store reported data from the web-vitals to some storage where we can get it later:</p>
<pre><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">storeWebVitals</span><span class="token punctuation">(</span><span class="token parameter">entry</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>window<span class="token punctuation">.</span>_cwv<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    window<span class="token punctuation">.</span>_cwv <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  window<span class="token punctuation">.</span>_cwv<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>entry<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">reportWebVitals</span><span class="token punctuation">(</span>storeWebVitals<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>And finally we need to read stored data it from our script:</p>
<pre><code class="language-typescript"><span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">extractCoreWebVitals</span><span class="token punctuation">(</span>page<span class="token operator">:</span> Page<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> rawMetrics <span class="token operator">=</span> <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">evaluate</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>_cwv<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> metrics<span class="token operator">:</span> <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span> value<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token punctuation">}</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>rawMetrics<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> formattedMetrics <span class="token operator">=</span> metrics<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span>
    <span class="token punctuation">(</span>result<span class="token punctuation">,</span> entry<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>result<span class="token punctuation">[</span>entry<span class="token punctuation">.</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> entry<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token keyword">as</span> Record<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">number</span><span class="token operator">&gt;</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> formattedMetrics<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>As a result you will something like this (depends on how much events was gathered from the page):</p>
<pre><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"TTFB"</span><span class="token operator">:</span> <span class="token number">48.19999999552965</span><span class="token punctuation">,</span>
  <span class="token property">"FCP"</span><span class="token operator">:</span> <span class="token number">96.29999999701977</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Now, it's time to talk about the most important metrics - your own custom metrics.</p>
<h2>How to get custom performance events from React application using Profiler</h2>
<p>I showed how to get performance events that already exist on the browser. But for the rich application, this will be not enough, especially for the single-page application. Imagine you want to measure how much time it was taken to show your main part of the content (or menu, or sidebar) or how much time the browser spent rendering your new WYSIWYG editor or any other fancy component with animation. Luckily, exactly for such cases, custom performance events are very handy. Let me show this in the example.</p>
<p>I will use React profiler API to get information when the component was finally rendered and the simplest example (it requires some tuning but should be OK enough for example) will be like this</p>
<pre><code class="language-js"><span class="token keyword">function</span> <span class="token function">putRenderedMark</span><span class="token punctuation">(</span><span class="token parameter">id<span class="token punctuation">,</span> phase<span class="token punctuation">,</span> actualDuration<span class="token punctuation">,</span> baseDuration<span class="token punctuation">,</span> startTime<span class="token punctuation">,</span> commitTime</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// make it one time</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>putRenderedMark<span class="token punctuation">.</span>_done<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    putRenderedMark<span class="token punctuation">.</span>_done <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    performance<span class="token punctuation">.</span><span class="token function">mark</span><span class="token punctuation">(</span><span class="token string">"app-rendered"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">App</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>
  <span class="token operator">&lt;</span>Profiler id<span class="token operator">=</span><span class="token string">"app-rendered"</span> onRender<span class="token operator">=</span><span class="token punctuation">{</span>putRenderedMark<span class="token punctuation">}</span><span class="token operator">&gt;</span>
    Hello from react
  <span class="token operator">&lt;</span><span class="token operator">/</span>Profiler<span class="token operator">&gt;</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>Retrieving is also simple:</p>
<pre><code class="language-typescript"><span class="token keyword">import</span> <span class="token punctuation">{</span> Page <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"puppeteer"</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">getAppRendered</span><span class="token punctuation">(</span>entries<span class="token operator">:</span> PerformanceEntry<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> appRenderedEvent <span class="token operator">=</span> entries<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">"app-rendered"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> appRenderedEvent<span class="token operator">?.</span>startTime <span class="token operator">??</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">getCustomMetrics</span><span class="token punctuation">(</span>page<span class="token operator">:</span> Page<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> rawEntries <span class="token operator">=</span> <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">evaluate</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>performance<span class="token punctuation">.</span><span class="token function">getEntries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> entries <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>rawEntries<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    appRendered<span class="token operator">:</span> <span class="token function">getAppRendered</span><span class="token punctuation">(</span>entries<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>And this is it! Now rebuild the application using <code>--profile</code> flag</p>
<pre><code class="language-cmd"><span class="token function">npm</span> run build -- --profile
</code></pre>
<p>Update <code>index.ts</code> to get custom metrics:</p>
<pre><code class="language-typescript"><span class="token comment">//dump custom metrics</span>
<span class="token keyword">const</span> customMetris <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getCustomMetrics</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>And run <code>e2e</code> script to observe the result!</p>
<p>That's it, this way you are able to mark and measure any timings you need to track everything that happens with your application without any external libraries and with extreme precision!
Very simple and very handy! But don't forget about the <code>--profile</code> flag it's required to enable Profiler on the Prod build for the React application.</p>
<p>Now let's wrap up with the first part of the article.</p>
<h2>Summary</h2>
<p>In the first part of the article, I've shown how easy is to use Puppeteer to get different performance entries for your React application. We managed to get ScriptDuration, LayoutDuration, Contentful Paint, Time To First Byte, and Largest Contentful Paint event. We also found how to create a custom performance event and extract it while profiling.</p>
<p>The second part of the article will be dedicated to the Puppeteer setup - emulating slow network, slow CPU, emulating mobile devices to gather more information about your application.
Demo repository with all code can be found here - <a href="https://github.com/Drag13/react-performance-puppeteer-profile">https://github.com/Drag13/react-performance-puppeteer-profile</a></p>
<p>Special thanks to @addyosmani for the inspiration and puppeteer team for make it possible.</p>
<p class="tag">07.06.2021 #performance, #react, #puppeteer, #webvitals</p></article></div></main><footer class="footer"><a href="https://github.com/Drag13/drag13.github.io/blob/development/LICENSE" rel="noopener" target="_blank" title="License">2022 MIT by Drag13</a></footer></body></html>